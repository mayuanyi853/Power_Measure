C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE C_MAIN
OBJECT MODULE PLACED IN .\C_Main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\System_Function\C_Main.c BROWSE INCDIR(..\CPU_Register;..\Hard_Module;..
                    -\System_Function) DEBUG OBJECTEXTEND PRINT(.\C_Main.lst) OBJECT(.\C_Main.obj)

line level    source

   1          
   2          /*=========================================================
   3                              ¹¦ÂÊ¼Æ       ----ÓÐÏÞ¹«Ë¾
   4          °æ    ±¾£ºV1.0
   5          ¿ª·¢Ê±¼ä£º2010Äê7ÔÂ26ÈÕ
   6          °æÈ¨ËùÓÐ£º2010--2099,ºÓ±±¿Æ¼¼´óÑ§  ÐÅÏ¢¿ÆÑ§Óë¹¤³ÌÏµ  ÃÏÖ¾ÓÀ
   7                                                                        ÊÖ»ú£º13933120973
   8                                                                                     Email£ºKDMZY@163.com
   9            ÎÄ ¼þ Ãû£ºC_Main.c
  10            ×÷    Õß: ÃÏÖ¾ÓÀ
  11            °æ    ±¾: V1.0
  12            Íê³ÉÈÕÆÚ: 2010Äê7ÔÂ29ÈÕ
  13            ÃèÊöÐÅÏ¢: ¹¦ÂÊ¼Æ
  14            ÆäËûËµÃ÷: Ð¾Æ¬ÀàÐÍ£ºSTC12C5604AD  Ö÷Æµ£º11.0592MHz       
  15            ¹¦ÄÜÁÐ±í: 
  16                                  1¡¢ÏµÍ³³õÊ¼»¯
  17                                  2¡¢CS5460Ð¾Æ¬³õÊ¼»¯¼°ÅäÖÃ
  18                                  3¡¢UART0´®ÐÐ¿ÚÊÕ·¢´¦Àí
  19                                  4¡¢6Í¨µÀµÄµçÁ÷ÕæÓÐÐ§Öµ¡¢µçÑ¹ÕæÓÐÐ§Öµ
  20                                  5¡¢485ÊÕ·¢¿ØÖÆ
  21            ÀúÊ·¼ÍÂ¼:   
  22                      1¡¢ÈÕ    ÆÚ:
  23                         ×÷    Õß:
  24                         ÐÞ¸ÄÄÚÈÝ:
  25          =========================================================*/
  26          
  27          /*=============Í·ÎÄ¼þÉùÃ÷================================*/
  28          #include "STC12C5620AD_H.h"
  29          
  30          #include "H_STC12C5404ADMdu.H"
  31          #include "H_STCE2PROM.h"
  32          #include "H_Interface.h"
  33          #include "H_CS5460.h"
  34          #include "intrins.h"
  35          
  36          /*=======================================================================
  37                                          ÏµÍ³¹«¹²±äÁ¿ÉùÃ÷
  38          =======================================================================*/
  39                            bit Flag_10ms   = 0;          // 10ms±êÖ¾
  40                           // bit Flag_100ms  = 0;        // 100ms±êÖ¾
  41                           // bit Flag_1000ms = 0;        // 1000ms±êÖ¾
  42                           // bit Flag_5s     = 0;      // 5Ãë±êÖ¾
  43          
  44          //unsigned char Counter_10ms   = 0;   // 10ms¼ÆÊýÆ÷
  45          //unsigned char Counter_100ms  = 0;     // 100ms¼ÆÊýÆ÷
  46          //unsigned char Counter_1000ms = 0;     // 1000ms¼ÆÊýÆ÷
  47          
  48          
  49          #define conSysPowerOnState  0x00        
  50          #define conSysIDLEState     0x01        
  51          #define conSysCabState      0x02    
  52          
  53          unsigned char System_State   = conSysPowerOnState;
  54          unsigned  int State_Timer    = 0;
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 2   

  55                            bit SystemLED_Flag;
  56          
  57          /*=======================================================================
  58          Êý¾ÝÉÏ´«¸ñÊ½ÈçÏÂ£º
  59          [@ZZ$D#YY-XX:0000.00V|0000.00A|0000.00W|0000.00Q|0000.00@|0000.00H|0000.00S|CRC]
  60          1¡¢ÒÔ'['¿ªÊ¼£¬ÒÔ']'½áÊø
  61          2¡¢@´Ó»úµØÖ·
  62          3¡¢#Í¨µÀºÅ
  63          4¡¢²ÎÊýÐòºÅ£º00£ºµçÑ¹
  64                       01£ºµçÁ÷
  65                                   02£º¹¦ÂÊ
  66                                   03£º¹¦ÂÊÒòÊý
  67                                   04£ºÏàÎ»²î½Ç
  68                                   05£ºÆµÂÊ
  69                                   06£ºÖÜÆÚ
  70                                   07£ºÔ¤Áô
  71                                   08£ºÔ¤Áô
  72                                   09£ºÔ¤Áô
  73                                   FF£º±íÊ¾ÒÔÉÏÈ«²¿²ÎÊý
  74                  Ã¿¸ö²ÎÊý²ÉÓÃ¹Ì¶¨¸ñÊ½£¬¼´0000.00µ¥Î»£¬¸÷¸ö²ÎÊýÒÔ¡®|¡¯¸ô¿ª
  75                  ¸÷¸ö²ÎÊýµÄ¾ßÌå·¶Î§ÈçÏÂ£º
  76                          µç    Ñ¹£º0¡«45.0V
  77                          µç    Á÷£º0¡«5A
  78                          ¹¦ ÂÊ Öµ£º0¡«2250W
  79          
  80          5¡¢³ý[]·ûºÅÒÔÍâµÄÆäËûÊý¾ÝµÄºÍÈ»ºó×ª»»ÎªASCIIÂë£¬·¶Î§´Ó000~256
  81          
  82          [@ZZ$R# R-XX:FFFFFF|CRC]:±íÊ¾ÉÏ´«µÄZZµ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
  83          [@ZZ$S#  ACK       |CRC]£º
  84          [@ZZ$S# nACK       |CRC]£º
  85          =======================================================================*/
  86          /*=======================================================================
  87          Êý¾ÝÏÂ´«¸ñÊ½ÈçÏÂ£º
  88          0123456789ABCDEF
  89          [@ZZ$D#YY-XX       CRC]£º±íÊ¾¶ÁÈ¡ZZµØÖ·µ¥Æ¬»úµÄYYÍ¨µÀµÄµÚXXÏî²ÎÊý
  90                                                   µ±XX=FFÊ±±íÊ¾£¬Ò»´Î»ñÈ¡ÆäYYÍ¨µÀµÄËùÓÐ²ÎÊý
  91          [@ZZ$R#R-XX        CRC]£º±íÊ¾¶ÁÈ¡FµØÖ·µ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
  92          
  93          [@ZZ$W#R-XX|FFFFFF CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄXX¼Ä´æÆ÷µÄÄÚÈÝ
  94          
  95          [@ZZ$C# 0-VIDC      CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐDCÐ£×¼
  96          [@ZZ$C# 1-VIAC      CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐACÐ£×¼
  97          [@ZZ$C# 2-VIGain    CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÔöÒæÐ£×¼
  98          [@ZZ$C# 3-VIOffset  CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÆ«ÖÃÐ£×¼
  99          
 100          [@ZZ$S#T-Cnn       CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄÊý¾Ý×Ô¶¯ÉÏ´«¹¦ÄÜµÄÉèÖÃ
 101                                   nn±íÊ¾Ê±¼ä¼ä¸ôµ¥Î»Ãë
 102                                                   nn=00Ê±±íÊ¾½ûÖ¹×Ô¶¯Á¬ÐøÉÏ´«¹¦ÄÜ
 103          [@ZZ$S#S-4800,8,1,0CRC]£º´®ÐÐ¿Ú²¨ÌØÂÊÉèÖÃ
 104          [@ZZ$S#A-XX        CRC]£ºÉèÖÃZZµ¥Æ¬»úµÄÍ¨Ñ¶µØÖ·ÎªXX
 105          =======================================================================*/
 106          unsigned char idata Device_Address;    // ±¾»úµØÖ·
 107          
 108          #define con_UART0TranMaxNum   30
 109          unsigned char idata UART0_TranBuf[con_UART0TranMaxNum]; //  = { "[ 0000.00V|0000.00A|0000.00W|0000.00Q|000
             -0.00@|0000.00H|0000.00S|]" }; // ´®ÐÐ¿Ú0µÄ·¢ËÍ»º³åÇø
 110          unsigned char idata UART0_TranMaxNum;
 111          unsigned char idata UART0_TranCounter;          // ´®ÐÐ¿Ú0µÄ·¢ËÍ¼ÆÊýÆ÷
 112          
 113          #define con_UART0ReceMaxNum        7
 114          unsigned char  data UART0_ReceBuf[con_UART0ReceMaxNum];                 // ´®ÐÐ¿Ú0½ÓÊÕ»º³åÇø
 115          unsigned char idata UART0_ReceCounter;          // ´®ÐÐ¿Ú0µÄ½ÓÊÕ¼ÆÊýÆ÷
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 3   

 116                            bit       UART0_ReceOKFlag = 0;       // ´®ÐÐ¿Ú0µÄ½ÓÊÕºÃ±êÖ¾
 117          unsigned char idata UART0_TranState;        // ´®ÐÐ¿ÚÉÏ´«×´Ì¬×Ö
 118          unsigned char idata UART0_TranChannel;      // ÒªÉÏ´«µÄÍ¨µÀºÅ
 119          
 120          unsigned char code con_HexCode[]  = { "0123456789ABCDEF" }; 
 121          unsigned char idata CS5460_Channel = 0;
 122          
 123          /*
 124          unsigned char xdata Measure_Buf[8][3][8] = {    // Êý¾Ý½á¹û»º³åÇø
 125                                                                                                  // 0Í¨µÀ
 126                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 127                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 128                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0',
 129                                                                                                  // 1Í¨µÀ 
 130                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 131                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 132                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 133                                                                                                  // 2Í¨µÀ
 134                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 135                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 136                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 137                                                                                                  // 3Í¨µÀ
 138                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 139                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 140                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0',
 141                                                                                                  // 4Í¨µÀ 
 142                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 143                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 144                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 145                                                                                                  // 5Í¨µÀ
 146                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 147                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 148                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 149                                                                                                  // 6Í¨µÀ
 150                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 151                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 152                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 153                                                                                                  // 7Í¨µÀ
 154                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 155                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 156                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0'
 157                                                                                          };
 158          
 159                          */
 160          
 161          
 162          unsigned  char   xdata  Measure_Buf[6][4]  = {
 163                                                                                                     0x00 ,0x00 ,0x00 ,0x00 ,        //1Â·µçÑ¹  Öµ µçÁ÷ £¬Öµ      ¹¦ÂÊ
 164                                                         0x00 ,0x00 ,0x00 ,0x00 ,
 165                                                                                                 0x00 ,0x00 ,0x00 ,0x00 ,
 166                                                                                                 0x00 ,0x00 ,0x00 ,0x00 ,
 167                                                                                                 0x00 ,0x00 ,0x00 ,0x00 ,
 168                                                                                             0x00 ,0x00 ,0x00 ,0x00 
 169                                                        };
 170          
 171          
 172          unsigned  int xdata    measure_ma[6][2]={
 173                                                                                                  0x0000 ,0x0000 ,           //1Â·µçÑ¹  maµçÁ÷ £¬ma       
 174                                                          0x0000 ,0x0000 ,
 175                                                                                                  0x0000 ,0x0000 ,
 176                                                                                                  0x0000 ,0x0000 ,
 177                                                                                                  0x0000 ,0x0000 ,
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 4   

 178                                                                                              0x0000 ,0x0000 
 179                                                                                                  };
 180          
 181          
 182          //unsigned  char xdata    measure_sys[6][4]={
 183          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,           //1Â·µçÑ¹ ÏµÊýµç   Á÷ £¬     ÏµÊý
 184           //                                               0x00 ,0x00 ,0x00 ,0x00 ,                                                              
 185          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,
 186          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,
 187          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,
 188          //                                                                                  0x00 ,0x00 ,0x00 ,0x00 
 189          //                                                                                      };
 190          
 191          unsigned  int   idata     v_sys[6]={ 0xd9c7 ,0xd9c7 ,0xd9c7,0xd9c7,0xd9c7,0xd9c7 };     //ÁùÂ·µçÑ¹ÏµÊý    r=215kÏ
             -µÊý=d9c7  (26000*65536/30563)
 192          
 193          
 194          
 195          //      float code conVoltage_Cof = (25000.0*0.98* 5.0 / 16777216.0);
 196                  //      float code conCurrent_Cof = (25000.0 * 5.0 / 16777216.0);
 197                  //      float code   conPower_Cof = (250.0*250.0 / 8388608.0);
 198          
 199          //          unsigned  int  code   conVoltage_sys=0xf522;         //         25400*65536/26526           =0xf522                 r=250k  
 200                  unsigned   int   code    conCurrent_sys=0x4ed;           // 408*65536/52ce                a=4.08                   ma=52ce
 201          unsigned char xdata Parameter_Buf[ 6 * 3 + 1 ]; // ²ÎÊý»º³åÇø
 202          
 203          unsigned char idata Read_State = 0;
 204          
 205          /*=======================================================================
 206                                  CS5460±êÖ¾Î»´¦Àí
 207          =======================================================================*/
 208          unsigned char bdata CS5460_Flag0;
 209          sbit DRDY_Flag = CS5460_Flag0^7;   // Êý¾ÝÓÐÐ§±êÖ¾ ÔÚÁ¬Ðø»òµ¥´Î×ª»»Ä£Ê½ÏÂ±íÃ÷¼ÆËã½á¹ûÒÑ¾­¾ÍÐ÷£¬ÔÚÐ£×¼Ä£Ê½Ï
             -Â±íÊ¾Ð£×¼Êý¾ÝÒÑ¾­Ð´Èëµ½ÏàÓ¦µÄ¼Ä´æÆ÷
 210          sbit EOUT_Flag = CS5460_Flag0^6; 
 211          sbit EDIR_Flag = CS5460_Flag0^5; 
 212          sbit CRDY_Flag = CS5460_Flag0^4; 
 213          sbit MATH_Flag = CS5460_Flag0^3; 
 214          //sbit RES_Flag  = CS5460_Flag0^2; 
 215          sbit IOR_Flag  = CS5460_Flag0^1; 
 216          sbit VOR_Flag  = CS5460_Flag0^0; 
 217          
 218          unsigned char bdata CS5460_Flag1;
 219          sbit PWOR_Flag = CS5460_Flag1^7; 
 220          sbit IROR_Flag = CS5460_Flag1^6; 
 221          sbit VROR_Flag = CS5460_Flag1^5; 
 222          sbit EOR_Flag  = CS5460_Flag1^4; 
 223          sbit EOOR_Flag = CS5460_Flag1^3; 
 224          //sbit RES_Flag  = CS5460_Flag1^2; 
 225          sbit ID3_Flag  = CS5460_Flag1^1; 
 226          sbit ID2_Flag  = CS5460_Flag1^0;
 227          
 228          unsigned char bdata CS5460_Flag2;
 229          sbit ID1_Flag = CS5460_Flag2^7; 
 230          sbit ID0_Flag = CS5460_Flag2^6; 
 231          sbit WDT_Flag = CS5460_Flag2^5; 
 232          sbit VOD_Flag = CS5460_Flag2^4; 
 233          sbit IOD_Flag = CS5460_Flag2^3; 
 234          sbit LSD_Flag = CS5460_Flag2^2; 
 235          //sbit 0_Flag   = CS5460_Flag2^1; 
 236          sbit nIC_Flag = CS5460_Flag2^0;
 237          
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 5   

 238          long idata CS5460_Status;  // CS5460µÄ×´Ì¬×Ö
 239          
 240          unsigned char idata CS5460_CabNum;  
 241                                                                                          
 242          //unsigned char code con_ChannelChange[] = { 1, 4, 5, 7, 3 , 6 };
 243          
 244          //unsigned char code con_ChannelChange[] = { 1, 4, 5, 2, 3 , 6 };
 245          
 246          
 247          unsigned char code con_ChannelChange[] = { 1,2, 3, 4, 5 , 6 };
 248          
 249          
 250          unsigned char idata Output_Channel;
 251          
 252          
 253          
 254           void read_vsys(void) ;
 255           void vself_cab(void) ;
 256          
 257          void delaynus (unsigned   char   n)
 258            { unsigned  char i;
 259   1            for(i=0 ;i<=n ;i++) 
 260   1                {_nop_();
 261   2                 _nop_();
 262   2                 }
 263   1                  
 264   1        }
 265          
 266          
 267          
 268          /*=======================================================================
 269          º¯ÊýÃû³Æ£ºstrTostr
 270          º¯Êý¹¦ÄÜ: ×Ö·û´®´«ËÍº¯Êý
 271          ÊäÈë²ÎÊý£º
 272          Êä³ö²ÎÊý£ºÎÞ
 273          ·µ »Ø Öµ£ºÎÞ
 274          ÆäËüËµÃ÷£º
 275          =======================================================================*/
 276          /*
 277          void strTostr( unsigned char *srcP, unsigned char *dstP, unsigned char Number ){
 278          
 279                  unsigned char i;
 280          
 281                  for( i = 0; i < Number; i++ ){ *srcP++ = *dstP++; }
 282          
 283          }
 284          
 285           */
 286          
 287          
 288          
 289          
 290          unsigned   char     strTostr( unsigned char *srcP, unsigned char *dstP, unsigned char Number ){
 291   1      
 292   1              unsigned char i ,temp  =0;
 293   1              for( i = 0; i < Number; i++ )
 294   1           { 
 295   2                 temp += *dstP;
 296   2                 *srcP++ = *dstP++; 
 297   2                 
 298   2            }
 299   1              return(temp);
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 6   

 300   1      
 301   1      }
 302          
 303          
 304          
 305          
 306          
 307          /*=======================================================================
 308          º¯ÊýÃû³Æ£ºHexASCIIToBin
 309          º¯Êý¹¦ÄÜ£º
 310          ÊäÈë²ÎÊý£º
 311          Êä³ö²ÎÊý£ºÎÞ
 312          ·µ »Ø Öµ£ºÎÞ
 313          ÆäËüËµÃ÷£º
 314          =======================================================================*/
 315          unsigned char HexASCIIToBin( unsigned char CVT_Data ){
 316   1      
 317   1              if( CVT_Data >= '0' && CVT_Data <= '9' ){ return ( CVT_Data - '0'); }
 318   1              else                                    { return ( CVT_Data - 'A' + 10 ); }
 319   1      
 320   1      }
 321          
 322          /*=======================================================================
 323          º¯ÊýÃû³Æ£ºLongToASCII
 324          º¯Êý¹¦ÄÜ£ºÕûÐÎÊý×ª»»ÎªASCII
 325          ÊäÈë²ÎÊý£º
 326          Êä³ö²ÎÊý£ºÎÞ
 327          ·µ »Ø Öµ£ºÎÞ
 328          ÆäËüËµÃ÷£º
 329          =======================================================================*/
 330          void LongToASCII( unsigned char *p, unsigned long CVT_Data, unsigned char Type_Flag ){
 331   1      
 332   1              *p++ = ' ';
 333   1              *p++ = con_HexCode[ CVT_Data / 100000 ];
 334   1              *p++ = con_HexCode[ CVT_Data % 100000 / 10000 ];
 335   1              if( Type_Flag == 'I' ){ *p++ = '.'; }
 336   1              *p++ = con_HexCode[ CVT_Data % 10000 / 1000 ];
 337   1              *p++ = con_HexCode[ CVT_Data % 1000 / 100 ];
 338   1              if( Type_Flag == 'V' || Type_Flag == 'P' ){ *p++ = '.'; }
 339   1              *p++ = con_HexCode[ CVT_Data % 100 / 10 ];
 340   1              *p++ = con_HexCode[ CVT_Data % 10 ];
 341   1      
 342   1      }
 343          
 344          /*=======================================================================
 345          º¯ÊýÃû³Æ£ºUART0_UnPacket
 346          º¯Êý¹¦ÄÜ£º´®ÐÐ¿Ú½â°üº¯Êý
 347          ÊäÈë²ÎÊý£ºÎÞ
 348          Êä³ö²ÎÊý£ºÎÞ
 349          ·µ »Ø Öµ£ºÎÞ
 350          ÆäËüËµÃ÷£º
 351          =======================================================================*/
 352          /*=======================================================================
 353          Êý¾ÝÏÂ´«¸ñÊ½ÈçÏÂ£º
 354          0123456789ABCDEF0123456
 355          [@0F$D#01-00        CR]£º±íÊ¾¶ÁÈ¡ZZµØÖ·µ¥Æ¬»úµÄYYÍ¨µÀµÄµÚXXÏî²ÎÊý
 356                                                   µ±XX=FFÊ±±íÊ¾£¬Ò»´Î»ñÈ¡ÆäYYÍ¨µÀµÄËùÓÐ²ÎÊý
 357          [@0F$R# R-0C        CR]£º±íÊ¾¶ÁÈ¡FµØÖ·µ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
 358          
 359          [@ZZ$W# R-XX|FFFFFF CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄXX¼Ä´æÆ÷µÄÄÚÈÝ
 360          
 361          [@ZZ$S# T-Cnn       CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄÊý¾Ý×Ô¶¯ÉÏ´«¹¦ÄÜµÄÉèÖÃ
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 7   

 362                                   nn±íÊ¾Ê±¼ä¼ä¸ôµ¥Î»Ãë
 363                                                   nn=00Ê±±íÊ¾½ûÖ¹×Ô¶¯Á¬ÐøÉÏ´«¹¦ÄÜ
 364          [@ZZ$S# S-4800,8,1,0CR]£º´®ÐÐ¿Ú²¨ÌØÂÊÉèÖÃ
 365          [@ZZ$S# A-XX        CR]£ºÉèÖÃZZµ¥Æ¬»úµÄÍ¨Ñ¶µØÖ·ÎªXX
 366          [FDF]
 367          [FCX]
 368          01234
 369          =======================================================================*/
 370          /*
 371          void UART0_UnPacket( void ){    
 372          
 373                  switch( UART0_ReceBuf[2] ){
 374                          case 'D': // ÒªÊý¾ÝµÄÃüÁî
 375                                          UART0_TranChannel   = HexASCIIToBin( UART0_ReceBuf[3] );
 376                                          if( UART0_TranChannel < 6 ){
 377                                              UART0_TranState = 'D';
 378                                          }                                
 379                                          break;
 380                          case 'C': 
 381                                          CS5460_CabNum = HexASCIIToBin( UART0_ReceBuf[3] );
 382                                          UART0_TranState = 'A'; // »Ø¸´ÕýÈ·Ó¦´ðÃüÁî
 383                                          System_State = conSysCabState; State_Timer = 0;  
 384                                          break;
 385                          default: UART0_TranState = 'Z'; break;
 386          
 387                  }
 388          
 389          }
 390          
 391          */
 392          
 393          
 394          
 395          void UART0_UnPacket( void ){    
 396   1      
 397   1              switch(  UART0_ReceBuf[3]){
 398   2                      case   0x03: // ÒªÊý¾ÝµÄÃüÁî
 399   2                              //      UART0_TranChannel   = HexASCIIToBin( UART0_ReceBuf[3] );
 400   2                              //      if( UART0_TranChannel < 6 ){
 401   2                              //          UART0_TranState = 'D';
 402   2                              //      }       
 403   2                                      UART0_TranState = 'D';
 404   2                                      break;
 405   2                      case 0x05:         //ÏµÍ³±ê¶¨
 406   2                                            //        CS5460_CabNum = HexASCIIToBin( UART0_ReceBuf[3] );
 407   2                      CS5460_CabNum = UART0_ReceBuf[4]; // ÕÒcon_CabTab[]        ÖÐ¶ÔÓ¦µÄÄÚÈÝ
 408   2                                      UART0_TranState = 'C'; // »Ø¸´ÕýÈ·Ó¦´ðÃüÁî
 409   2                                      System_State = conSysCabState; State_Timer = 0;  //
 410   2                      
 411   2                                      break;   //
 412   2                      case 0x06: 
 413   2                                      vself_cab( );
 414   2                                              break;
 415   2      
 416   2                      default: UART0_TranState = 'Z'; break;
 417   2      
 418   2              }
 419   1      
 420   1      }
 421          
 422          
 423          
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 8   

 424          
 425          
 426          /*=======================================================================
 427          º¯ÊýÃû³Æ£ºUART0_Packet
 428          º¯Êý¹¦ÄÜ£º´¦Àí´®ÐÐ¿ÚÒª·¢ËÍµÄÊý¾Ý°ü ²¢×Ô¶¯Æô¶¯·¢ËÍ
 429          ÊäÈë²ÎÊý£º
 430          Êä³ö²ÎÊý£ºÎÞ
 431          ·µ »Ø Öµ£ºÎÞ
 432          ÆäËüËµÃ÷£º
 433          =======================================================================*/
 434          /*
 435          void UART0_Packet( void ){
 436          
 437                  UART0_TranBuf[0] = '[';                                   // ·ÅÈëÆðÊ¼×Ö·û
 438                  UART0_TranBuf[1] = Device_Address;  // ·ÅÈëµØÖ·
 439                  // ÉÏ´«Êý¾Ý´ò°ü¹ý³Ì
 440                  switch( UART0_TranState ){              
 441                          case 'D': // ÉÏ´«²É¼¯µ½µÄÊý¾ÝÃüÁî
 442                                  UART0_TranBuf[ 2] = con_HexCode[ UART0_TranChannel ];
 443                                          // È«²¿²ÎÊýÉÏ´«
 444                                          strTostr( &UART0_TranBuf[3],  &Measure_Buf[UART0_TranChannel][0], 8 );
 445                                          strTostr( &UART0_TranBuf[11], &Measure_Buf[UART0_TranChannel][1], 8 );
 446                                  //      strTostr( &UART0_TranBuf[19], &Measure_Buf[UART0_TranChannel][2], 8 );
 447                                          UART0_TranBuf[19] = ']';
 448                                          UART0_TranMaxNum = 20;
 449                                          break;   
 450                          case 'C':  // ÉÏ´«Íê³É×´Ì¬ [@ZZ$C# XOK     |CRC]£º
 451                                          UART0_TranBuf[ 2] = 'C'; 
 452                                          UART0_TranBuf[ 3] = con_HexCode[ CS5460_CabNum ];
 453                                          UART0_TranBuf[ 4] = 'O'; 
 454                                          UART0_TranBuf[ 5] = 'K'; 
 455                                          UART0_TranBuf[ 6] = ']'; 
 456                                          UART0_TranMaxNum = 7;
 457                                          break;
 458                          case 'A':  // ÉÏ´«ÕýÈ·Ó¦´ð×´Ì¬ [@ZZ$S# ACK|CRC]£º
 459                                          UART0_TranBuf[ 2] = 'A'; 
 460                                          UART0_TranBuf[ 3] = 'C'; 
 461                                          UART0_TranBuf[ 4] = 'K'; 
 462                                          UART0_TranBuf[ 5] = ']'; 
 463                                          UART0_TranMaxNum = 6;
 464                                          break;
 465                          case 'Z':  // ÉÏ´«ÎÞ·¨Ó¦´ð×´Ì¬ 
 466                                          UART0_TranBuf[ 2] = 'n'; 
 467                                          UART0_TranBuf[ 3] = 'A'; 
 468                                          UART0_TranBuf[ 4] = 'C'; 
 469                                          UART0_TranBuf[ 5] = 'K';                                         
 470                                          UART0_TranBuf[ 6] = ']';
 471                                          UART0_TranMaxNum = 7;
 472                                          break;
 473                          default: break;
 474                  }
 475              UART0_TranCounter = 0;
 476                  Max485_Tran;             // 485·¢ËÍÊ¹ÄÜ
 477                  TI = 1;  // °ÑÊý¾Ý·¢ËÍ³öÈ¥
 478                  UART0_TranState = 0;
 479          
 480          }
 481          
 482            */
 483          
 484          
 485          
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 9   

 486          void UART0_Packet( void ){
 487   1               unsigned  char   chkdata;
 488   1              UART0_TranBuf[0] = 0x6c;                                          // ·ÅÈëÆðÊ¼×Ö·û
 489   1              UART0_TranBuf[1] = 0x63;
 490   1              UART0_TranBuf[2] = Device_Address;  // ·ÅÈëµØÖ·
 491   1              // ÉÏ´«Êý¾Ý´ò°ü¹ý³Ì
 492   1              switch( UART0_TranState ){              
 493   2                      case 'D': // ÉÏ´«²É¼¯µ½µÄÊý¾ÝÃüÁî
 494   2                            //  UART0_TranBuf[ 2] = con_HexCode[ UART0_TranChannel ];
 495   2                                      // È«²¿²ÎÊýÉÏ´«
 496   2      
 497   2                                     chkdata= strTostr( &UART0_TranBuf[3],  &Measure_Buf[0], 24 );
 498   2                                       //     strTostr( &UART0_TranBuf[11], &Measure_Buf[UART0_TranChannel][1], 8 );
 499   2      
 500   2                              //      strTostr( &UART0_TranBuf[19], &Measure_Buf[UART0_TranChannel][2], 8 );
 501   2                                  chkdata += UART0_TranBuf[2];
 502   2                                      UART0_TranBuf[27] = chkdata;      //chk
 503   2                                      UART0_TranBuf[28] = 0x0d;
 504   2                                      UART0_TranMaxNum = 29;
 505   2                                      break;   
 506   2                      case 'C':  // ÉÏ´«Íê³É×´Ì¬ [@ZZ$C# XOK     |CRC]£º
 507   2                              //      UART0_TranBuf[ 3] = 'C'; 
 508   2                              //      UART0_TranBuf[ 4] = con_HexCode[ CS5460_CabNum ];
 509   2                              //      UART0_TranBuf[ 5] = 'O'; 
 510   2                              //      UART0_TranBuf[ 6] = 'K'; 
 511   2                              //      UART0_TranBuf[ 7] = ']'; 
 512   2                                      UART0_TranBuf[ 3] = Parameter_Buf[17]; 
 513   2                                      UART0_TranBuf[ 4] = Parameter_Buf[16];
 514   2                                      UART0_TranBuf[ 5] = Parameter_Buf[15]; 
 515   2                                      UART0_TranBuf[ 6] = Parameter_Buf[11]; 
 516   2                                      UART0_TranBuf[ 7] = Parameter_Buf[10];
 517   2                                      UART0_TranBuf[ 8] = Parameter_Buf[9];
 518   2      
 519   2      
 520   2      
 521   2                                      UART0_TranMaxNum = 9;
 522   2                                      break;
 523   2                      case 'A':  // ÉÏ´«ÕýÈ·Ó¦´ð×´Ì¬ [@ZZ$S# ACK|CRC]£º
 524   2                                      UART0_TranBuf[ 3] = 'A'; 
 525   2                                      UART0_TranBuf[ 4] = 'C'; 
 526   2                                      UART0_TranBuf[ 5] = 'K'; 
 527   2                                      UART0_TranBuf[ 6] = ']'; 
 528   2                                      UART0_TranMaxNum = 7;
 529   2                                      break;
 530   2                      case 'Z':  // ÉÏ´«ÎÞ·¨Ó¦´ð×´Ì¬ 
 531   2                                      UART0_TranBuf[ 3] = 'n'; 
 532   2                                      UART0_TranBuf[ 4] = 'A'; 
 533   2                                      UART0_TranBuf[ 5] = 'C'; 
 534   2                                      UART0_TranBuf[ 6] = 'K';                                         
 535   2                                      UART0_TranBuf[ 7] = ']';
 536   2                                      UART0_TranMaxNum = 8;
 537   2                                      break;
 538   2                      default: break;
 539   2              }
 540   1          UART0_TranCounter = 0;
 541   1              Max485_Tran;             // 485·¢ËÍÊ¹ÄÜ
 542   1              TI = 1;  // °ÑÊý¾Ý·¢ËÍ³öÈ¥
 543   1              UART0_TranState = 0;
 544   1      
 545   1      }
 546          
 547          
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 10  

 548          
 549          
 550          /*=======================================================================
 551          º¯ÊýÃû³Æ£ºGet_Parameter
 552          º¯Êý¹¦ÄÜ£º»ñÈ¡²ÎÊýÖµ, Í¬Ê±ÅäÖÃCS5460
 553          ÊäÈë²ÎÊý£ºÎÞ
 554          Êä³ö²ÎÊý£ºÎÞ
 555          ·µ »Ø Öµ£ºÎÞ
 556          ÆäËüËµÃ÷£º
 557          =======================================================================*/
 558          void Get_Parameter( void ){
 559   1      
 560   1              unsigned char i;
 561   1              unsigned  int Parameter_Address;
 562   1      
 563   1              Parameter_Address = 0;
 564   1      
 565   1              for( i = 0; i < (6 * 3 + 1); i++ ){
 566   2                      Parameter_Buf[i] = ISP_Byte_Read( Parameter_Address++ );
 567   2              }
 568   1      
 569   1              // Èç¹û²ÎÊýÕýÈ· ÔòÅäÖÃCS5460
 570   1              if( Parameter_Buf[ ( 6*3 ) ] == 0x00 ){ 
 571   2                      CS5460_WriteReg( addIDCOffset, Parameter_Buf[ 2 ], Parameter_Buf[ 1 ], Parameter_Buf[ 0 ] );
 572   2                      CS5460_WriteReg( addIGain,     Parameter_Buf[ 5 ], Parameter_Buf[ 4 ], Parameter_Buf[ 3 ] );
 573   2                      CS5460_WriteReg( addVDCOffset, Parameter_Buf[ 8 ], Parameter_Buf[ 7 ], Parameter_Buf[ 6 ] );
 574   2                      CS5460_WriteReg( addVGain,     Parameter_Buf[ 11 ], Parameter_Buf[ 10 ], Parameter_Buf[ 9 ] );
 575   2                      CS5460_WriteReg( addIACOffset, Parameter_Buf[ 14 ], Parameter_Buf[ 13 ], Parameter_Buf[ 12 ] );
 576   2                      CS5460_WriteReg( addVACOffset, Parameter_Buf[ 17 ], Parameter_Buf[ 16 ], Parameter_Buf[ 15 ] );
 577   2              }
 578   1      
 579   1      }
 580          
 581           /*
 582          void Get_Parameter( void ){
 583          
 584                  unsigned char i;
 585                  unsigned  int Parameter_Address;
 586          
 587                  Parameter_Address = 0;
 588          
 589                  for( i = 0; i < (6 * 3 + 1); i++ ){
 590                          Parameter_Buf[i] = ISP_Byte_Read( Parameter_Address++ );
 591                  }
 592          
 593                  // Èç¹û²ÎÊýÕýÈ· ÔòÅäÖÃCS5460
 594                  if( Parameter_Buf[ ( 6*3 ) ] == 0x00 ){ 
 595                          CS5460_WriteReg( addIDCOffset, Parameter_Buf[ 0 ], Parameter_Buf[ 1 ], Parameter_Buf[ 2 ] );
 596                          CS5460_WriteReg( addIGain,     Parameter_Buf[ 3 ], Parameter_Buf[ 4 ], Parameter_Buf[ 5 ] );
 597                          CS5460_WriteReg( addVDCOffset, Parameter_Buf[ 6 ], Parameter_Buf[ 7 ], Parameter_Buf[ 8 ] );
 598                          CS5460_WriteReg( addVGain,     Parameter_Buf[ 9 ], Parameter_Buf[ 10 ], Parameter_Buf[ 11 ] );
 599                          CS5460_WriteReg( addIACOffset, Parameter_Buf[ 12 ], Parameter_Buf[ 13 ], Parameter_Buf[ 14 ] );
 600                          CS5460_WriteReg( addVACOffset, Parameter_Buf[ 15 ], Parameter_Buf[ 16 ], Parameter_Buf[ 17 ] );
 601                  }
 602          
 603          }
 604          
 605           */
 606          
 607          /*=======================================================================
 608          º¯ÊýÃû³Æ£ºSave_Parameter
 609          º¯Êý¹¦ÄÜ£º±£´æ²ÎÊýÖµ
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 11  

 610          ÊäÈë²ÎÊý£ºÎÞ
 611          Êä³ö²ÎÊý£ºÎÞ
 612          ·µ »Ø Öµ£ºÎÞ
 613          ÆäËüËµÃ÷£º
 614          =======================================================================*/
 615          void Save_Parameter( void ){
 616   1      
 617   1              unsigned char i;
 618   1              unsigned  int Parameter_Address;
 619   1      
 620   1              Parameter_Address = 0;
 621   1              Sector_Erase( Parameter_Address );
 622   1      
 623   1              CS5460_Status = CS5460_ReadReg( addIDCOffset );
 624   1              Parameter_Buf[ 0 ]  = CS5460_Status;     
 625   1              Parameter_Buf[ 1 ]  = ( CS5460_Status >> 8 );
 626   1              Parameter_Buf[ 2 ]  = ( CS5460_Status   >> 16 );
 627   1      
 628   1              CS5460_Status = CS5460_ReadReg( addIGain );
 629   1              Parameter_Buf[ 3 ]  = CS5460_Status;     
 630   1              Parameter_Buf[ 4 ]  = ( CS5460_Status >> 8 );
 631   1              Parameter_Buf[ 5 ]  = ( CS5460_Status   >> 16 );
 632   1      
 633   1              CS5460_Status = CS5460_ReadReg( addVDCOffset );
 634   1              Parameter_Buf[ 6 ]  = CS5460_Status;     
 635   1              Parameter_Buf[ 7 ]  = ( CS5460_Status >> 8 );
 636   1              Parameter_Buf[ 8 ]  = ( CS5460_Status   >> 16 );
 637   1      
 638   1      
 639   1              CS5460_Status = CS5460_ReadReg( addVGain );
 640   1              Parameter_Buf[ 9 ]  = CS5460_Status;     
 641   1              Parameter_Buf[ 10 ]  = ( CS5460_Status >> 8 );
 642   1              Parameter_Buf[ 11 ]  = ( CS5460_Status  >> 16 );
 643   1      
 644   1              CS5460_Status = CS5460_ReadReg( addIACOffset );
 645   1              Parameter_Buf[ 12 ]  = CS5460_Status;    
 646   1              Parameter_Buf[ 13 ]  = ( CS5460_Status >> 8 );
 647   1              Parameter_Buf[ 14 ]  = ( CS5460_Status  >> 16 );
 648   1      
 649   1              CS5460_Status = CS5460_ReadReg( addVACOffset );
 650   1              Parameter_Buf[ 15 ]  = CS5460_Status;    
 651   1              Parameter_Buf[ 16 ]  = ( CS5460_Status >> 8 );
 652   1              Parameter_Buf[ 17 ]  = ( CS5460_Status  >> 16 );
 653   1      
 654   1              Parameter_Buf[ 18 ]  = 0x00;
 655   1      
 656   1              for( i = 0; i < (6 * 3 + 1); i++ ){
 657   2                      ISP_Byte_Write( Parameter_Address++, Parameter_Buf[i] );
 658   2              }
 659   1      
 660   1      }
 661          
 662          
 663          /*=======================================================================
 664          º¯ÊýÃû³Æ£ºSystem_PowerOn
 665          º¯Êý¹¦ÄÜ£ºÏµÍ³¸ÕÉÏµçÐèÒª´¦ÀíµÄÊÂÇé
 666          ÊäÈë²ÎÊý£ºÎÞ
 667          Êä³ö²ÎÊý£ºÎÞ
 668          ·µ »Ø Öµ£ºÎÞ
 669          ÆäËüËµÃ÷£º1¡¢ÑÓÊ±1S
 670                            2¡¢Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 671                            3¡¢Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 12  

 672                            4¡¢¸´Î»CS5460
 673                            5¡¢Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 674          =======================================================================*/
 675          void System_PowerOn( void ){
 676   1      
 677   1              // Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 678   1              if( (State_Timer % 30) == 0 ) { SystemLED_Flag = ~SystemLED_Flag; }
 679   1      
 680   1              // Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ ¸´Î»CS5460
 681   1              if( State_Timer == 100 ){
 682   2                      CS5460_RSTLow;
 683   2                      CS5460_Channel = 0;
 684   2                      CD4051_A = 1;
 685   2                      CD4051_B = 0;
 686   2                      CD4051_C = 0;
 687   2                      CD4051_EN0 = 0;
 688   2                      CD4051_EN1 = 0;
 689   2      
 690   2              }
 691   1              if( State_Timer == 103 ){ CS5460_RSTHigh; } // ¸´Î»Íê³É
 692   1      
 693   1              // Í¬²½CS5460µÄ´®ÐÐ¿Ú
 694   1              if( State_Timer == 104 ){
 695   2                      CS5460_CSLow;
 696   2                      CS5460_Send( cmdSYNC1 );  // 
 697   2                      CS5460_Send( cmdSYNC1 );  // 
 698   2                      CS5460_Send( cmdSYNC1 );  // 
 699   2                      CS5460_Send( cmdSYNC0 );  // 
 700   2                      CS5460_CSHigh;
 701   2              
 702   2                      CS5460_WriteReg( addConfig, 0x00, 0x10, 0x63 ); // ÅäÖÃConfig
 703   2              //      CS5460_WriteReg( addConfig, 0x00, 0x10, 0x03 ); // ÅäÖÃConfig
 704   2              //      Get_Parameter();   //¶Á±ê¶¨²ÎÊý  µ½cs5460ÖÐ
 705   2                  read_vsys(); //´Óeeprom   ÖÐ¶ÁÈËÏµÊýµ½v¡ª¡ª¡ªsys¡¾¡¿Êý×éÖÐ
 706   2              }                                          
 707   1      
 708   1              if( State_Timer == 106 ){                       
 709   2                      CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî  
 710   2                      // »ñÈ¡Éè±¸µØÖ·
 711   2                      Device_Address = P1;
 712   2                      Device_Address >>= 4;
 713   2              //      Device_Address = Device_Address & 0x03;//p1.4 p1.5
 714   2              //      Device_Address =  con_HexCode[Device_Address];
 715   2                      System_State = conSysIDLEState; State_Timer = 0;  // 1Ãëºó Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 716   2                      Max485_Rece;
 717   2              }
 718   1      
 719   1      }
 720          
 721           /*
 722          void System_PowerOn( void ){
 723          
 724                  // Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 725                  if( (State_Timer % 30) == 0 ) { SystemLED_Flag = ~SystemLED_Flag; }
 726          
 727                  // Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ ¸´Î»CS5460
 728                  if( State_Timer == 100 ){
 729                          CS5460_RSTLow;
 730                          CS5460_Channel = 0;
 731                          CD4051_A = 1;
 732                          CD4051_B = 0;
 733                          CD4051_C = 0;
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 13  

 734                          CD4051_EN0 = 0;
 735                          CD4051_EN1 = 0;
 736          
 737                  }
 738                  if( State_Timer == 103 ){ CS5460_RSTHigh; } // ¸´Î»Íê³É
 739          
 740                  // Í¬²½CS5460µÄ´®ÐÐ¿Ú
 741                  if( State_Timer == 104 ){
 742                          CS5460_CSLow;
 743                          CS5460_Send( cmdSYNC1 );  // 
 744                          CS5460_Send( cmdSYNC1 );  // 
 745                          CS5460_Send( cmdSYNC1 );  // 
 746                          CS5460_Send( cmdSYNC0 );  // 
 747                          CS5460_CSHigh;
 748                  
 749                          CS5460_WriteReg( addConfig, 0x00, 0x10, 0x63 ); // ÅäÖÃConfig
 750                  }
 751          
 752                  if( State_Timer == 106 ){                       
 753                          CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî  
 754                          // »ñÈ¡Éè±¸µØÖ·
 755                          Device_Address = P1;
 756                          Device_Address >>= 4;
 757                  //      Device_Address =  con_HexCode[Device_Address];
 758                          System_State = conSysIDLEState; State_Timer = 0;  // 1Ãëºó Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 759                          Max485_Rece;
 760                  }
 761          
 762          }
 763          
 764          
 765           */
 766          
 767          /*=======================================================================
 768          º¯ÊýÃû³Æ£ºSystem_IDLE
 769          º¯Êý¹¦ÄÜ£ºÏµÍ³¿ÕÏÐÐèÒª´¦ÀíµÄÊÂÇé
 770          ÊäÈë²ÎÊý£ºÎÞ
 771          Êä³ö²ÎÊý£ºÎÞ
 772          ·µ »Ø Öµ£ºÎÞ
 773          ÆäËüËµÃ÷£º1¡¢Ö¸Ê¾µÆÒÔ1SÉÁË¸
 774                            2¡¢Ã¿Ò»ÃëÇÐ»»Ò»´ÎÍ¨µÀ£¬Æô¶¯CS5460×ª»»Ò»´Î£¬¶ÁÈ¡Ò»´Î×ª»»½á¹û£¬²¢°Ñ½á¹û¸üÐÂµ½ÏàÓ¦µÄ»º³åÇø
 775                            3¡¢Èç¹ûÊÕµ½´®ÐÐ¿ÚÊý¾Ý°ü£¬Ôò½â°ü²¢´¦Àí
 776                            4¡¢Ã¿Ò»ÃëÊý¾Ý´ò°üÒ»´Î£¬²¢Ö÷¶¯ÉÏ´«Ò»´Î£¨µ÷ÊÔÓÃ£©
 777          =======================================================================*/
 778          /*
 779          void System_IDLE( void ){       
 780          
 781                    bit Plus_Flag;
 782                  float Temp_f;
 783                  unsigned long Temp_l;
 784          
 785                  // Ã¿10ms¶ÁÒ»´ÎCS5460µÄ×´Ì¬×Ö£¬¸ù¾Ý×´Ì¬×ÖÀ´ÅÐ¶ÏÏÂÒ»²½µÄ²Ù×÷
 786                  CS5460_Status = CS5460_ReadReg( addStatus );
 787                  CS5460_Flag2  = CS5460_Status;   
 788                  CS5460_Flag1  = ( CS5460_Status >> 8 );
 789                  CS5460_Flag0  = ( CS5460_Status >> 16 );
 790                  if( DRDY_Flag == 1 ){ // ¶ÁÈ¡µ±Ç°×ª»»½á¹û                       
 791                          Read_State++;
 792                          if( Read_State != 3 ){
 793                                  // Çå³ý±êÖ¾
 794                                  CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 795                                  Temp_l = CS5460_ReadReg( addVRMS );
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 14  

 796                                  Temp_l = CS5460_ReadReg( addIRMS );
 797                                  Temp_l = CS5460_ReadReg( addP );
 798                          }
 799                          if( Read_State >= 3 ){ Read_State = 0;
 800                                  // »ñÈ¡µçÑ¹ÕæÓÐÐ§Öµ                     
 801                                  Temp_f = CS5460_ReadReg( addVRMS ); // ×ª»»Îª¸¡µãÊý
 802                                  Temp_f *= conVoltage_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 803                                  Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 804                                  // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø         
 805                                  LongToASCII( &Measure_Buf[CS5460_Channel][0][0], Temp_l, 'V' );
 806                                  // »ñÈ¡µçÁ÷ÕæÓÐÐ§Öµ
 807                                  Temp_f = CS5460_ReadReg( addIRMS );     // ×ª»»Îª¸¡µãÊý
 808                                  Temp_f *= conCurrent_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 809                                  Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 810                                  // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 811                                  LongToASCII( &Measure_Buf[CS5460_Channel][1][0], Temp_l, 'I' );
 812                                  // »ñÈ¡¹¦ÂÊÖµ
 813                                  Temp_l = CS5460_ReadReg( addP );
 814                                  Plus_Flag = 0;
 815                                  if( Temp_l & 0x00800000 ){ 
 816                                          Plus_Flag = 1; 
 817                                          Temp_l &= 0x007FFFFF; 
 818                                  }
 819                                  Temp_f = Temp_l;        // ×ª»»Îª¸¡µãÊý
 820                                  Temp_f *= conPower_Cof;         // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 821                                  Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 822                                  // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 823                                  LongToASCII( &Measure_Buf[CS5460_Channel][2][0], Temp_l, 'P' );
 824                                  if( Plus_Flag ) { Measure_Buf[CS5460_Channel][2][0] = '-'; }
 825                                  // Çå³ý±êÖ¾
 826                                  CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 827                                  // ÇÐ»»Í¨µÀ
 828                                  CS5460_Channel++;
 829                                  if( CS5460_Channel >= 6 ){ CS5460_Channel = 0; }
 830                                  //CS5460_Channel = 1;
 831                                  Output_Channel = con_ChannelChange[ CS5460_Channel ];
 832                                  CD4051_EN0 = 1; 
 833                                  CD4051_EN1 = 1;
 834                                  if( ( Output_Channel & 0x01 ) == 0x01 ){ CD4051_A = 1; }
 835                                  else                                   { CD4051_A = 0; }
 836                                  if( ( Output_Channel & 0x02 ) == 0x02 ){ CD4051_B = 1; }
 837                                  else                                   { CD4051_B = 0; }
 838                                  if( ( Output_Channel & 0x04 ) == 0x04 ){ CD4051_C = 1; }
 839                                  else                                   { CD4051_C = 0; }
 840                                  CD4051_EN0 = 0; 
 841                                  CD4051_EN1 = 0;
 842                          }
 843                          
 844                  }
 845          
 846                  // 1sµ½
 847                  if( ( State_Timer % 100 ) == 0 ){ State_Timer = 0;
 848                          SystemLED_Flag = ~SystemLED_Flag;
 849                  }
 850          
 851          }  
 852          
 853           */
 854          
 855          
 856          
 857          void System_IDLE( void ){       
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 15  

 858   1      
 859   1      //        bit Plus_Flag;
 860   1      //      float Temp_f;
 861   1              unsigned long Temp_l;
 862   1      
 863   1      
 864   1      //      unsigned  char   *p;
 865   1      
 866   1              // Ã¿10ms¶ÁÒ»´ÎCS5460µÄ×´Ì¬×Ö£¬¸ù¾Ý×´Ì¬×ÖÀ´ÅÐ¶ÏÏÂÒ»²½µÄ²Ù×÷
 867   1              CS5460_Status = CS5460_ReadReg( addStatus );
 868   1              CS5460_Flag2  = CS5460_Status;   
 869   1              CS5460_Flag1  = ( CS5460_Status >> 8 );
 870   1              CS5460_Flag0  = ( CS5460_Status >> 16 );
 871   1              if( DRDY_Flag == 1 ){ // ¶ÁÈ¡µ±Ç°×ª»»½á¹û                       
 872   2                      Read_State++;
 873   2                      if( Read_State != 3 ){
 874   3                              // Çå³ý±êÖ¾
 875   3                              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 876   3                              Temp_l = CS5460_ReadReg( addVRMS );
 877   3                              Temp_l = CS5460_ReadReg( addIRMS );
 878   3                              Temp_l = CS5460_ReadReg( addP );
 879   3                      }
 880   2                      if( Read_State >= 3 ){ Read_State = 0;
 881   3                              // »ñÈ¡µçÑ¹ÕæÓÐÐ§Öµ                     
 882   3                         //   Temp_f = CS5460_ReadReg( addVRMS ); // ×ª»»Îª¸¡µãÊý
 883   3                         //   Temp_f *= conVoltage_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 884   3                        //    Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 885   3      
 886   3                                      Temp_l=CS5460_ReadReg(addVRMS);
 887   3                                      Temp_l=Temp_l>>8;                             // yong  2  zhi jie
 888   3                              
 889   3                                      measure_ma[CS5460_Channel][0]=Temp_l;// cun ri ma
 890   3                                      Temp_l=Temp_l* v_sys[CS5460_Channel];
 891   3                                      Temp_l=Temp_l>>16;
 892   3      
 893   3      
 894   3      
 895   3                              //      Temp_l=Temp_l* conVoltage_sys;
 896   3                              //      Temp_l=Temp_l>>16;
 897   3      
 898   3                              //      p=(unsigned  char *) (&Temp_l);
 899   3                              //      UART0_TranBuf[4]=*p++;            //add
 900   3                              //      UART0_TranBuf[5]=*p++;            //add
 901   3                              //      UART0_TranBuf[6]=*p++;            //add
 902   3                              //      UART0_TranBuf[7]=*p++;            //add
 903   3      
 904   3      
 905   3      
 906   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø         
 907   3                      //      LongToASCII( &Measure_Buf[CS5460_Channel][0][0], Temp_l, 'V' );
 908   3                           Measure_Buf[CS5460_Channel][1]=Temp_l;
 909   3                   Measure_Buf[CS5460_Channel][0]=Temp_l>>8;
 910   3                   
 911   3                              // »ñÈ¡µçÁ÷ÕæÓÐÐ§Öµ
 912   3                      //      Temp_f = CS5460_ReadReg( addIRMS );     // ×ª»»Îª¸¡µãÊý
 913   3                      //      Temp_f *= conCurrent_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 914   3                      //      Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 915   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 916   3                      //      LongToASCII( &Measure_Buf[CS5460_Channel][1][0], Temp_l, 'I' );
 917   3                              // »ñÈ¡¹¦ÂÊÖµ
 918   3                         Temp_l=CS5460_ReadReg(addIRMS);
 919   3                 Temp_l=Temp_l>>8;
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 16  

 920   3                         Temp_l=Temp_l*conCurrent_sys;
 921   3                         Temp_l=Temp_l>>16;
 922   3                 Measure_Buf[CS5460_Channel][3]=Temp_l;
 923   3                 Measure_Buf[CS5460_Channel][2]=Temp_l>>8;  //µçÁ÷Âë
 924   3      
 925   3      
 926   3      
 927   3                       //     Temp_l = CS5460_ReadReg( addP );
 928   3                      //      Plus_Flag = 0;
 929   3                      //      if( Temp_l & 0x00800000 ){ 
 930   3                      //              Plus_Flag = 1; 
 931   3                      //              Temp_l &= 0x007FFFFF; 
 932   3                      //      }
 933   3                      //      Temp_f = Temp_l;        // ×ª»»Îª¸¡µãÊý
 934   3                      //      Temp_f *= conPower_Cof;         // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 935   3                      //      Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 936   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 937   3                      //      LongToASCII( &Measure_Buf[CS5460_Channel][2][0], Temp_l, 'P' );
 938   3                      //      if( Plus_Flag ) { Measure_Buf[CS5460_Channel][2][0] = '-'; }
 939   3                              // Çå³ý±êÖ¾
 940   3                              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 941   3                              // ÇÐ»»Í¨µÀ
 942   3                              CS5460_Channel++;
 943   3                              if( CS5460_Channel >= 6 ){ CS5460_Channel = 0; }
 944   3                              //CS5460_Channel = 1;
 945   3                              Output_Channel = con_ChannelChange[ CS5460_Channel ];
 946   3                              CD4051_EN0 = 1; 
 947   3                              CD4051_EN1 = 1;
 948   3                              if( ( Output_Channel & 0x01 ) == 0x01 ){ CD4051_A = 1; }
 949   3                              else                                   { CD4051_A = 0; }
 950   3                              if( ( Output_Channel & 0x02 ) == 0x02 ){ CD4051_B = 1; }
 951   3                              else                                   { CD4051_B = 0; }
 952   3                              if( ( Output_Channel & 0x04 ) == 0x04 ){ CD4051_C = 1; }
 953   3                              else                                   { CD4051_C = 0; }
 954   3                              CD4051_EN0 = 0; 
 955   3                              CD4051_EN1 = 0;
 956   3                      }
 957   2                      
 958   2              }
 959   1      
 960   1              // 1sµ½
 961   1              if( ( State_Timer % 100 ) == 0 ){ State_Timer = 0;
 962   2                      SystemLED_Flag = ~SystemLED_Flag;
 963   2              }
 964   1      
 965   1      }  
 966          
 967          
 968          
 969          
 970          
 971          /*=======================================================================
 972          º¯ÊýÃû³Æ£ºWait_DRDY
 973          º¯Êý¹¦ÄÜ: 
 974          ÊäÈë²ÎÊý£ºÎÞ
 975          Êä³ö²ÎÊý£ºÎÞ
 976          ·µ »Ø Öµ£ºÎÞ
 977          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
 978                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
 979                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
 980          =======================================================================*/
 981          void Wait_DRDY( void ){
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 17  

 982   1              CS5460_Status = CS5460_ReadReg( addStatus );
 983   1              CS5460_Flag2  = CS5460_Status;   
 984   1              CS5460_Flag1  = ( CS5460_Status >> 8 );
 985   1              CS5460_Flag0  = ( CS5460_Status >> 16 );
 986   1      }
 987          /*                                                       
 988          unsigned char code con_CabTab[] = { (0xC1 | 0x01), (0xC1 | 0x05), (0xC1 | 0x02), (0xC1 | 0x06),
 989                                                                    
 990                                                                                  (0xD0 | 0x01), (0xD0 | 0x05), (0xD0 | 0x02), (0xD0 | 0x06)
 991                                                                            };
 992          
 993           */
 994          unsigned char code con_CabTab[] = { (0xC8 | 0x01), (0xC8 | 0x05), (0xC8 | 0x02), (0xC8 | 0x06),
 995                                                                    
 996                                                                                  (0xD0 | 0x01), (0xD0 | 0x05), (0xD0 | 0x02), (0xD0 | 0x06)
 997                                                                            };
 998          
 999          
1000          /*=======================================================================
1001          º¯ÊýÃû³Æ£ºSystem_Cab
1002          º¯Êý¹¦ÄÜ£ºÏµÍ³Ð£×¼º¯Êý
1003          ÊäÈë²ÎÊý£ºÎÞ
1004          Êä³ö²ÎÊý£ºÎÞ
1005          ·µ »Ø Öµ£ºÎÞ
1006          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
1007                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
1008                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
1009          =======================================================================*/
1010          /*
1011          void System_Cab( void ){
1012          
1013                  SystemLED_Flag = con_LEDOn;
1014          
1015                  // Çå±ê¼Ç
1016                  CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF );
1017                  // 1¡¢·¢ËÍPower_UpÃüÁî
1018                  CS5460_SendCmd( cmdPowerUpHalt );
1019                  // Çå±ê¼Ç
1020                  CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF ); 
1021          
1022                  CS5460_SendCmd( con_CabTab[ CS5460_CabNum ]  );
1023                  DRDY_Flag = 0;
1024                  while( DRDY_Flag == 0 ){
1025                     Wait_DRDY();
1026                  }
1027          
1028                  CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
1029          
1030                  Save_Parameter( );
1031                  CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî
1032          
1033                  UART0_TranState = 'C';
1034                  // Ï¨ÃðLED
1035                  SystemLED_Flag = con_LEDOff;
1036                  // ÇÐ»»µ½ÏµÍ³¿ÕÏÐ×´Ì¬
1037                  System_State = conSysIDLEState; State_Timer = 0;
1038          
1039          }
1040          
1041           */
1042          
1043          /*=======================================================================
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 18  

1044          º¯ÊýÃû³Æ£ºSystem_Cab
1045          º¯Êý¹¦ÄÜ£ºÏµÍ³Ð£×¼º¯Êý
1046          ÊäÈë²ÎÊý£ºÎÞ
1047          Êä³ö²ÎÊý£ºÎÞ
1048          ·µ »Ø Öµ£ºÎÞ
1049          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
1050                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
1051                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
1052          =======================================================================*/
1053          void System_Cab( void ){
1054   1      
1055   1        //    SystemLED_Flag = con_LEDOn;
1056   1          System_LED  =       con_LEDOn;
1057   1      
1058   1              CS5460_Channel=0;  //tong dap1 
1059   1              CD4051_A=1;
1060   1              CD4051_B=0;
1061   1              CD4051_C=0;        // tong dao 1
1062   1              _nop_();
1063   1              _nop_();
1064   1              _nop_();
1065   1              _nop_();
1066   1      
1067   1              CD4051_EN0=0;
1068   1              CD4051_EN1=0; //4051  enable 
1069   1      
1070   1              _nop_();
1071   1              _nop_();
1072   1              _nop_();
1073   1              _nop_();
1074   1      
1075   1              _nop_();
1076   1              _nop_();
1077   1              _nop_();
1078   1              _nop_();
1079   1              delaynus (200) ;
1080   1      
1081   1              // Çå±ê¼Ç
1082   1              CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF );
1083   1      
1084   1              _nop_();
1085   1              _nop_();
1086   1              _nop_();
1087   1              _nop_();
1088   1                      delaynus (200) ;
1089   1              // 1¡¢·¢ËÍPower_UpÃüÁî
1090   1              CS5460_SendCmd( cmdPowerUpHalt );
1091   1      
1092   1              _nop_();
1093   1              _nop_();
1094   1              _nop_();
1095   1              _nop_();
1096   1              // Çå±ê¼Ç
1097   1              CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF ); 
1098   1              _nop_();
1099   1              _nop_();
1100   1              _nop_();
1101   1              _nop_();
1102   1                      delaynus (200) ;
1103   1      
1104   1              
1105   1              
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 19  

1106   1              CS5460_SendCmd( con_CabTab[ CS5460_CabNum ]  );           
1107   1          
1108   1              DRDY_Flag = 0;
1109   1              while( DRDY_Flag == 0 ){
1110   2                 Wait_DRDY();
1111   2                 WDT_CONTR = 0x38;    
1112   2              }
1113   1      
1114   1              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
1115   1      
1116   1      
1117   1      
1118   1           
1119   1              Save_Parameter( );
1120   1              CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî
1121   1      
1122   1              UART0_TranState = 'C';
1123   1              // Ï¨ÃðLED
1124   1              SystemLED_Flag = con_LEDOff;
1125   1              // ÇÐ»»µ½ÏµÍ³¿ÕÏÐ×´Ì¬
1126   1              System_State = conSysIDLEState; State_Timer = 0;
1127   1              
1128   1      
1129   1      }
1130          
1131          
1132          
1133           /*======================================================
1134              ×Ô±ê¶¨
1135             °Ñ²É³öµÄÊý ÓÃ220v    µÄ±ê×¼      x=22000 *65536 /       Âë
1136             ¼ÆËãºóµÄÊý   ÓÒÒÆÁ½¸ö×Ö½Ú            È»ºó´æÈË200 ¿ªÊ¼µÄµÚ¶þÉÈÇø
1137             212  ´æÈë01 
1138            =====================================================*/
1139          
1140          
1141           void vself_cab(void)
1142              {unsigned  char i,templ ,temph;
1143   1               unsigned  int  temp_sys;
1144   1               unsigned  int    ee_address;
1145   1                   
1146   1                   System_LED  =      con_LEDOn;
1147   1                       ee_address=0x200;
1148   1               Sector_Erase(ee_address);
1149   1      
1150   1                       for(i=0; i<=5; i++)
1151   1                 {
1152   2                                temp_sys= 0x55f00000 / measure_ma[i][0] ;     //22000*65536
1153   2                            v_sys[i]=temp_sys;          //´æÈËµçÑ¹ÏµÊý
1154   2                                templ=temp_sys;
1155   2                                temph=temp_sys>>8;
1156   2                    ISP_Byte_Write(ee_address++ ,temph);//
1157   2                                ISP_Byte_Write(ee_address++ ,templ);  //
1158   2                     }
1159   1              
1160   1                        ISP_Byte_Write(0x212 ,0x01);   //eeprom   212´æÈë01h
1161   1                
1162   1              }
1163          
1164          
1165           /*================================
1166            ÏÈ¶Á212µØÖ·µÄÊý¾ÝÊÇ·ñ01
1167            ÊÇ £¬¶ÁÈëÊý¾Ý·ÅÈë¶ÔÓ¦µÄÏµÊýÖÐ
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 20  

1168          
1169          
1170          
1171           ==================================*/
1172          
1173           void read_vsys(void)
1174             { unsigned  char i,  temp_data ,temp_datah ,temp_datal;
1175   1           unsigned int  temp_w;
1176   1           unsigned int ee_address;
1177   1               ee_address=0x200;
1178   1           temp_data= ISP_Byte_Read( 0x212 );//ÅÐ212ÊÇ·ñÊÇ01h
1179   1               if(temp_data==0x01)
1180   1                  {for(i=0;i<=5 ;i++)
1181   2                         { temp_datah = ISP_Byte_Read(ee_address++);
1182   3                           temp_datal=  ISP_Byte_Read(ee_address++);
1183   3                               temp_w=temp_datah;
1184   3                               temp_w<<=8;
1185   3                               temp_w+=temp_datal;
1186   3                               v_sys[i]=temp_w;       //´æÈëÏµÊýµ½ÄÚ´æÊý×éÖÐ
1187   3                         }
1188   2              }
1189   1           
1190   1         }
1191          
1192          
1193          /*====================================================================       ===
1194          º¯ÊýÃû³Æ£ºOutput_Port
1195          º¯Êý¹¦ÄÜ£º¶Ë¿ÚË¢ÐÂº¯Êý
1196          ÊäÈë²ÎÊý£ºÎÞ
1197          Êä³ö²ÎÊý£ºÎÞ
1198          ·µ »Ø Öµ£ºÎÞ
1199          ÆäËüËµÃ÷£ºÎÞ
1200          =======================================================================*/
1201          void Output_Port( void ){
1202   1      
1203   1              System_LED = SystemLED_Flag;
1204   1      
1205   1      }
1206          
1207          /*=======================================================================
1208          º¯ÊýÃû³Æ£ºmain
1209          º¯Êý¹¦ÄÜ£º
1210          ÊäÈë²ÎÊý£ºÎÞ
1211          Êä³ö²ÎÊý£ºÎÞ
1212          ·µ »Ø Öµ£ºÎÞ
1213          ÆäËüËµÃ÷£ºÎÞ
1214          =======================================================================*/
1215          void main( void ){
1216   1              bit bdata biao_flag=0;
1217   1              Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
1218   1              System_LED = con_LEDOn;  // µãÁÁÏµÍ³Ö¸Ê¾µÆ
1219   1              Init_System( );
1220   1      
1221   1              while(1){ 
1222   2                      WDT_CONTR = 0x38;
1223   2                              if((STL==0 ) && (biao_flag==0) )
1224   2                                {     vself_cab( );
1225   3                                  biao_flag=1;
1226   3                                }      
1227   2                      // Ã¿10msÒª×öµÄÊÂÇé
1228   2                      if( Flag_10ms ){ Flag_10ms = 0;         
1229   3                                 WDT_CONTR = 0x38;
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 21  

1230   3                                              // ×ÜÒª×öµÄÊÂÇé
1231   3                              if( UART0_ReceOKFlag ){ // ´®ÐÐ¿Ú½ÓÊÕºÃ
1232   4                                      UART0_UnPacket( );      // µ÷ÓÃ´®ÐÐ¿Ú½â°üÃüÁî
1233   4                                      UART0_ReceOKFlag = 0; // Çå½ÓÊÕºÃ±ê¼Ç
1234   4                              }
1235   3                              if( UART0_TranState ){ UART0_Packet(); }
1236   3                              // ÏµÍ³×´Ì¬»ú´¦Àí
1237   3                              if( State_Timer < 65530 ) { State_Timer++; }                    
1238   3                              switch( System_State ){
1239   4                                      case conSysPowerOnState: System_PowerOn(); break;
1240   4                                      case conSysIDLEState:    System_IDLE();    break;
1241   4                                      case conSysCabState:     System_Cab();     break;
1242   4                                      default: System_State = conSysPowerOnState; State_Timer = 0;  break;
1243   4                              } // ÏµÍ³×´Ì¬»ú´¦Àí½áÊø
1244   3      
1245   3                              // 10msË¢ÐÂÒ»´ÎÊä³ö¶Ë¿Ú
1246   3                              Output_Port( );
1247   3      
1248   3                      } // 10msÊÂ¼þ´¦Àí½áÊø
1249   2              }
1250   1      
1251   1      }
1252          
1253          
1254          
1255          /*=======================================================================
1256          º¯ÊýÃû³Æ£ºISR_INT0  Íâ²¿ÖÐ¶Ï0µÄÖÐ¶Ï·þÎñ
1257          º¯Êý¹¦ÄÜ£ººìÍâÏßÊäÈë¼ì²â          
1258          ÊäÈë²ÎÊý£ºÎÞ
1259          Êä³ö²ÎÊý£ºÎÞ
1260          ·µ »Ø Öµ£ºÎÞ
1261          ÆäËüËµÃ÷£ºÎÞ
1262          =======================================================================*/
1263          void ISR_INT0( void ) interrupt 0  using 1{
1264   1              
1265   1                       
1266   1      }
1267          
1268          /*=======================================================================
1269          º¯ÊýÃû³Æ£ºISR_Timer0  ¶¨Ê±Æ÷T0ÖÐ¶Ï·þÎñ
1270          º¯Êý¹¦ÄÜ£ºÊµÏÖ10ms¶¨Ê±ÖÐ¶Ï          
1271          ÊäÈë²ÎÊý£ºÎÞ
1272          Êä³ö²ÎÊý£ºÎÞ
1273          ·µ »Ø Öµ£ºÎÞ
1274          ÆäËüËµÃ÷£ºÎÞ
1275          =======================================================================*/
1276          void ISR_Timer0( void ) interrupt 1  //using 1
1277          {
1278   1                                
1279   1              TH0   = 0xD5;
1280   1              TL0   = 0x9D;
1281   1      
1282   1              Flag_10ms = 1;
1283   1      
1284   1      } 
1285          
1286          /*=======================================================================
1287          º¯ÊýÃû³Æ£ºISR_INT1  Íâ²¿ÖÐ¶Ï1µÄÖÐ¶Ï·þÎñ
1288          º¯Êý¹¦ÄÜ£º¼üÅÌÊäÈë¼ì²â          
1289          ÊäÈë²ÎÊý£ºÎÞ
1290          Êä³ö²ÎÊý£ºÎÞ
1291          ·µ »Ø Öµ£ºÎÞ
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 22  

1292          ÆäËüËµÃ÷£ºÎÞ
1293          =======================================================================*/
1294          void ISR_INT1( void ) interrupt 2  //using 1
1295          {
1296   1               
1297   1      }
1298          
1299          /*=======================================================================
1300          º¯ÊýÃû³Æ£ºISR_Timer1  ¶¨Ê±Æ÷T1ÖÐ¶Ï·þÎñ
1301          º¯Êý¹¦ÄÜ£ºÊµÏÖ1ms¶¨Ê±ÖÐ¶Ï          
1302          ÊäÈë²ÎÊý£ºÎÞ
1303          Êä³ö²ÎÊý£ºÎÞ
1304          ·µ »Ø Öµ£ºÎÞ
1305          ÆäËüËµÃ÷£ºÎÞ
1306          =======================================================================*/
1307          void ISR_Timer1( void ) interrupt 3 // using 1
1308          {
1309   1      
1310   1      }
1311          
1312          /*=======================================================================
1313          º¯ÊýÃû³Æ£ºISR_Serial0 ´®ÐÐ¿Ú0ÖÐ¶Ï·þÎñ
1314          º¯Êý¹¦ÄÜ£ºÏµÍ³µ÷ÊÔ      
1315          ÊäÈë²ÎÊý£ºÎÞ
1316          Êä³ö²ÎÊý£ºÎÞ
1317          ·µ »Ø Öµ£ºÎÞ
1318          ÆäËüËµÃ÷£ºÎÞ
1319          =======================================================================*/
1320          
1321          
1322          
1323          
1324          void ISR_UART0( void ) interrupt 4 // using 1
1325          {
1326   1          unsigned char Temp_Data;
1327   1      
1328   1              // ½ÓÊÕÖÐ¶Ï
1329   1          if( RI ){  RI = 0;
1330   2                      if( UART0_ReceOKFlag == 0 ){
1331   3                          Temp_Data = SBUF;
1332   3                          if( Temp_Data == 0x4c ){    UART0_ReceCounter = 0; }
1333   3                          UART0_ReceBuf[ UART0_ReceCounter++ ] = Temp_Data;
1334   3                          if( UART0_ReceCounter == con_UART0ReceMaxNum ){
1335   4                              UART0_ReceCounter = 0;
1336   4                              if( (UART0_ReceBuf[1] == 0x57 )&& ((UART0_ReceBuf[3]==0x03) ||(UART0_ReceBuf[3]==0x05) ||(UART0_
             -ReceBuf[3]==0x06))       &&(UART0_ReceBuf[6]==0x0d)){ // °üÍêÕûÐÔÐ£Ñé
1337   5                                              // ±¾»úµØÖ·Ð£Ñé
1338   5                                              if( UART0_ReceBuf[2] == Device_Address ){
1339   6                                                  UART0_ReceOKFlag = 1; // µ÷ÊÔÓÃ,ÔÝ²»×öCRCÐ£Ñé
1340   6                                              }                              
1341   5                                  }
1342   4                          }
1343   3                      }
1344   2              }
1345   1      
1346   1              // ·¢ËÍÖÐ¶Ï
1347   1              if( TI ){ TI = 0; 
1348   2                      if( UART0_TranCounter < UART0_TranMaxNum ){
1349   3                          delaynus(10);
1350   3                              SBUF = UART0_TranBuf[ UART0_TranCounter++ ];                    
1351   3                      }
1352   2                      else{
C51 COMPILER V9.00   C_MAIN                                                                11/25/2014 15:16:38 PAGE 23  

1353   3                              Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
1354   3                      }
1355   2              }
1356   1      
1357   1      }
1358          
1359          
1360          
1361          
1362          
1363          /*
1364          void ISR_UART0( void ) interrupt 4 // using 1
1365          {
1366              unsigned char Temp_Data;
1367          
1368                  // ½ÓÊÕÖÐ¶Ï
1369              if( RI ){  RI = 0;
1370                          if( UART0_ReceOKFlag == 0 ){
1371                              Temp_Data = SBUF;
1372                              if( Temp_Data == '[' ){     UART0_ReceCounter = 0; }
1373                              UART0_ReceBuf[ UART0_ReceCounter++ ] = Temp_Data;
1374                              if( UART0_ReceCounter == con_UART0ReceMaxNum ){
1375                                  UART0_ReceCounter = 0;
1376                                  if( Temp_Data == ']' ){ // °üÍêÕûÐÔÐ£Ñé
1377                                                  // ±¾»úµØÖ·Ð£Ñé
1378                                                  if( UART0_ReceBuf[1] == con_HexCode[Device_Address] ){
1379                                                      UART0_ReceOKFlag = 1; // µ÷ÊÔÓÃ,ÔÝ²»×öCRCÐ£Ñé
1380                                                  }                              
1381                                      }
1382                              }
1383                          }
1384                  }
1385          
1386                  // ·¢ËÍÖÐ¶Ï
1387                  if( TI ){ TI = 0; 
1388                          if( UART0_TranCounter < UART0_TranMaxNum ){
1389                                  SBUF = UART0_TranBuf[ UART0_TranCounter++ ];                    
1390                          }
1391                          else{
1392                                  Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
1393                          }
1394                  }
1395          
1396          }
1397          
1398          */
1399          
1400          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2534    ----
   CONSTANT SIZE    =     33    ----
   XDATA SIZE       =     67    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13      36
   IDATA SIZE       =     56    ----
   BIT SIZE         =      3       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
